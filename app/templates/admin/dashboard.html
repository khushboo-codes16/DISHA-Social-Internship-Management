{% extends "admin/base.html" %}

{% block title %}Admin Dashboard - DISHA{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}
{% block page_subtitle %}Welcome back, {{ current_user.name }}! Here's your administration overview.{% endblock %}

{% block content %}
<div class="space-y-6">

    <!-- Statistics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-semibold">Total Students</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="liveTotalStudents">{{ stats.total_students }}</h3>
                    <div class="mt-2 text-sm text-gray-600">
                        Registered students
                    </div>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fas fa-users text-blue-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500" id="studentsUpdateTime"></div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-semibold">Total Tolis</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="liveTotalTolis">{{ stats.total_tolis }}</h3>
                    <div class="mt-2 text-sm text-gray-600">
                        Created tolis
                    </div>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="fas fa-users-cog text-green-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500" id="tolisUpdateTime"></div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-semibold">Total Programs</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="liveTotalPrograms">{{ stats.total_programs }}</h3>
                    <div class="mt-2 text-sm text-gray-600">
                        Programs available
                    </div>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class="fas fa-calendar-check text-purple-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500" id="programsUpdateTime"></div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 text-sm font-semibold">Resources</p>
                    <h3 class="text-3xl font-bold text-gray-800 mt-2" id="liveTotalResources">{{ stats.total_resources }}</h3>
                    <div class="mt-2 text-sm text-gray-600">
                        Available for students
                    </div>
                </div>
                <div class="bg-yellow-100 p-3 rounded-full">
                    <i class="fas fa-file-alt text-yellow-600 text-xl"></i>
                </div>
            </div>
            <div class="mt-2 text-xs text-gray-500" id="resourcesUpdateTime"></div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <a href="{{ url_for('admin.add_student') }}" class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:scale-105 border-2 border-dashed border-gray-300 hover:border-blue-500 card-hover">
            <div class="bg-blue-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user-plus text-blue-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-800 mb-2">Add Student</h3>
            <p class="text-sm text-gray-600">Register new student</p>
        </a>

        <a href="{{ url_for('admin.manage_tolis') }}" class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:scale-105 border-2 border-dashed border-gray-300 hover:border-green-500 card-hover">
            <div class="bg-green-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-users text-green-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-800 mb-2">Manage Tolis</h3>
            <p class="text-sm text-gray-600">Approve & manage tolis</p>
        </a>

        <a href="{{ url_for('admin.upload_resource') }}" class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:scale-105 border-2 border-dashed border-gray-300 hover:border-purple-500 card-hover">
            <div class="bg-purple-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-upload text-purple-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-800 mb-2">Upload Resource</h3>
            <p class="text-sm text-gray-600">Share learning materials</p>
        </a>

        <a href="{{ url_for('admin.send_message') }}" class="bg-white rounded-xl shadow-lg p-6 text-center hover:shadow-xl transition-all duration-300 transform hover:scale-105 border-2 border-dashed border-gray-300 hover:border-orange-500 card-hover">
            <div class="bg-orange-100 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-envelope text-orange-600 text-xl"></i>
            </div>
            <h3 class="font-semibold text-gray-800 mb-2">Send Message</h3>
            <p class="text-sm text-gray-600">Communicate with students</p>
        </a>
    </div>

    <!-- Recent Activity & Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Recent Activity -->
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Recent Activity</h3>
                <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full">Live</span>
            </div>
            <div class="space-y-4" id="recentActivitiesContainer">
                {% for activity in recent_activities %}
                <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center 
                        {% if activity.type == 'toli' %}bg-green-100 text-green-600
                        {% elif activity.type == 'student' %}bg-blue-100 text-blue-600
                        {% elif activity.type == 'program' %}bg-purple-100 text-purple-600
                        {% else %}bg-gray-100 text-gray-600{% endif %}">
                        <i class="fas fa-{{ activity.icon }}"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-sm font-medium text-gray-800">{{ activity.message }}</p>
                        <p class="text-xs text-gray-500">{{ activity.time }}</p>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-info-circle text-4xl text-gray-300 mb-3"></i>
                    <p class="text-gray-600">No recent activity</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Program Types Distribution -->
        <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
            <h3 class="text-xl font-bold text-gray-800 mb-6">Program Types Distribution</h3>
            <div class="h-64">
                <canvas id="programTypeChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>

// Real-time statistics updates
let lastUpdateTimes = {};

async function updateLiveStats() {
    try {
        const response = await fetch('/admin/api/dashboard/live-stats');
        const data = await response.json();
        
        if (data.error) {
            console.error('Error fetching live stats:', data.error);
            return;
        }
        
        // Update statistics with animation
        animateCounter('liveTotalStudents', data.total_students);
        animateCounter('liveTotalTolis', data.total_tolis);
        animateCounter('liveTotalPrograms', data.total_programs);
        animateCounter('liveTotalResources', data.total_resources);
        
        // Update last updated time
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        document.querySelectorAll('[id$="UpdateTime"]').forEach(el => {
            el.textContent = `Updated: ${timeString}`;
        });
        
        // Store last update time
        lastUpdateTimes.dashboard = now;
        
    } catch (error) {
        console.error('Error updating live stats:', error);
    }
}

// Animate counter values
function animateCounter(elementId, newValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    // Check if the value is actually different
    const currentValue = element.textContent;
    if (currentValue === newValue.toString()) return;
    
    // Add animation class
    element.classList.add('text-blue-600', 'font-bold');
    
    // Update value
    element.textContent = newValue;
    
    // Remove animation class after a delay
    setTimeout(() => {
        element.classList.remove('text-blue-600', 'font-bold');
    }, 1000);
}

// Update recent activities in real-time
async function updateRecentActivities() {
    try {
        const response = await fetch('/admin/api/recent-activities');
        
        if (!response.ok) {
            console.warn('Recent activities API returned:', response.status);
            return;
        }
        
        const data = await response.json();
        
        if (data.success && data.activities && data.activities.length > 0) {
            const activitiesContainer = document.getElementById('recentActivitiesContainer');
            if (activitiesContainer) {
                activitiesContainer.innerHTML = '';
                
                data.activities.forEach(activity => {
                    const activityHTML = `
                        <div class="flex items-center space-x-4 p-3 bg-gray-50 rounded-lg">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center 
                                ${activity.type === 'toli' ? 'bg-green-100 text-green-600' :
                                  activity.type === 'student' ? 'bg-blue-100 text-blue-600' :
                                  activity.type === 'program' ? 'bg-purple-100 text-purple-600' :
                                  'bg-gray-100 text-gray-600'}">
                                <i class="fas fa-${activity.icon || 'info-circle'}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium text-gray-800">${activity.message || 'Activity'}</p>
                                <p class="text-xs text-gray-500">${activity.time || 'Just now'}</p>
                            </div>
                        </div>
                    `;
                    activitiesContainer.innerHTML += activityHTML;
                });
            }
        }
    } catch (error) {
        console.error('Error updating recent activities:', error);
        // Don't show error to user, just log it
    }
}

// Initialize real-time updates
document.addEventListener('DOMContentLoaded', function() {
    // Update stats immediately
    updateLiveStats();
    updateRecentActivities();
    
    // Update every 30 seconds
    setInterval(updateLiveStats, 30000);
    setInterval(updateRecentActivities, 45000);
    
    // Also update when the page becomes visible again
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            updateLiveStats();
            updateRecentActivities();
        }
    });
});

// Program Type Chart with Real-Time Data from Student Programs
let programTypeChart = null;

async function createProgramChart() {
    const programTypeCtx = document.getElementById('programTypeChart');
    
    if (!programTypeCtx) {
        console.error('Chart canvas not found');
        return;
    }
    
    const ctx = programTypeCtx.getContext('2d');
    
    // Check if Chart is available
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded');
        return;
    }
    
    try {
        // Get real-time data from server
        const programLabels = {{ program_types_labels|default(["No Programs Yet"])|tojson|safe }};
        const programData = {{ program_types_data|default([0])|tojson|safe }};
        
        // Create chart
        programTypeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: programLabels,
                datasets: [{
                    data: programData,
                    backgroundColor: [
                        '#3B82F6', '#10B981', '#8B5CF6', '#F59E0B', 
                        '#EF4444', '#6366F1', '#EC4899', '#14B8A6',
                        '#F97316', '#84CC16'
                    ],
                    borderWidth: 2,
                    borderColor: '#FFFFFF'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Based on Real Student Programs',
                        font: {
                            size: 12,
                            style: 'italic'
                        },
                        color: '#6B7280'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${label}: ${value} programs (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error creating chart:', error);
    }
}

// Update chart with real-time data
async function updateProgramChart() {
    try {
        const response = await fetch('/admin/api/dashboard/program-types');
        
        if (!response.ok) {
            console.warn('Program types API returned:', response.status);
            return;
        }
        
        const data = await response.json();
        
        if (data.success && programTypeChart) {
            // Update chart data
            programTypeChart.data.labels = data.labels;
            programTypeChart.data.datasets[0].data = data.data;
            
            // Update chart
            programTypeChart.update('none'); // 'none' for instant update without animation
            
            console.log(`Chart updated: ${data.total_programs} total programs`);
        }
    } catch (error) {
        console.error('Error updating program chart:', error);
    }
}

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
    createProgramChart();
    
    // Update chart every 60 seconds
    setInterval(updateProgramChart, 60000);
});

// Update current time
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        hour12: true 
    });
    const timeElement = document.getElementById('currentTime');
    if (timeElement) {
        timeElement.textContent = timeString;
    }
}
setInterval(updateTime, 1000);
updateTime();
</script>
{% endblock %}