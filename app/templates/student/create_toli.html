{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-blue-800 mb-6">Create Your Toli</h1>
    
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h3 class="text-xl font-semibold text-blue-800 mb-4">ðŸ“‹ Toli Creation Rules</h3>
        <ul class="list-disc list-inside space-y-2 text-gray-700">
            <li>You will automatically become the <strong>Toli Leader</strong> ðŸ‘‘</li>
            <li>Add members by entering their <strong>Scholar Numbers</strong></li>
            <li>Member details will be <strong>automatically filled</strong></li>
            <li>You can have <strong>any number of members</strong> (including just yourself)</li>
            <li>Toli requires admin approval before becoming active</li>
        </ul>
    </div>

    <form method="POST" class="bg-white p-6 rounded-lg shadow-md" id="toliForm">
        <!-- Toli Basic Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Toli Number *</label>
                <input type="text" name="toli_no" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="e.g., TOLI-001">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Session Year *</label>
                <input type="text" name="session_year" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="e.g., 2024-2025">
            </div>
        </div>

        <!-- Current User as Leader -->
        <div class="bg-yellow-50 p-4 rounded-lg mb-6 border-2 border-yellow-400">
            <h4 class="text-lg font-semibold text-yellow-800 mb-3">ðŸ‘‘ Toli Leader (You)</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><strong>Name:</strong> {{ current_user.name }}</div>
                <div><strong>Scholar No:</strong> {{ current_user.scholar_no }}</div>
                <div><strong>Course:</strong> {{ current_user.course }}</div>
                <div><strong>Contact:</strong> {{ current_user.contact }}</div>
                <div class="md:col-span-2"><strong>Email:</strong> {{ current_user.email }}</div>
            </div>
        </div>

        <!-- Additional Members -->
        <div id="membersSection">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-blue-800">ðŸ‘¥ Add Team Members</h3>
                <button type="button" onclick="addMemberField()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>Add Member
                </button>
            </div>
            
            <div id="membersContainer">
                <!-- Member fields will be added here dynamically -->
            </div>
        </div>

        <!-- Submit Button -->
        <div class="mt-8">
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                <i class="fas fa-users mr-2"></i>Create Toli & Submit for Approval
            </button>
            <a href="{{ url_for('student.dashboard') }}" class="ml-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                Cancel
            </a>
        </div>
    </form>
</div>

<!-- JavaScript for dynamic member fields and auto-fill -->
<script>
let memberCount = 0;

function addMemberField() {
    memberCount++;
    const container = document.getElementById('membersContainer');
    
    const memberDiv = document.createElement('div');
    memberDiv.className = 'member-field bg-blue-50 p-4 rounded-lg mb-4 border-2 border-blue-200';
    memberDiv.innerHTML = `
        <div class="flex justify-between items-center mb-3">
            <h5 class="font-semibold text-blue-700">Member ${memberCount}</h5>
            <button type="button" onclick="removeMemberField(this)" class="text-red-500 hover:text-red-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Scholar Number *</label>
                <input type="text" 
                       name="member_${memberCount}_scholar_no" 
                       class="scholar-input w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                       placeholder="Enter scholar number"
                       onblur="fetchStudentDetails(this)"
                       required>
                <div class="validation-message text-xs mt-1"></div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                <input type="text" class="name-field w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Course</label>
                <input type="text" class="course-field w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Contact</label>
                <input type="text" class="contact-field w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="text" class="email-field w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
            </div>
        </div>
    `;
    
    container.appendChild(memberDiv);
}

function removeMemberField(button) {
    const memberDiv = button.closest('.member-field');
    memberDiv.remove();
    // Re-number remaining members
    updateMemberNumbers();
}

function updateMemberNumbers() {
    const members = document.querySelectorAll('.member-field');
    members.forEach((member, index) => {
        const title = member.querySelector('h5');
        const scholarInput = member.querySelector('.scholar-input');
        title.textContent = `Member ${index + 1}`;
        scholarInput.name = `member_${index + 1}_scholar_no`;
    });
    memberCount = members.length;
}

async function fetchStudentDetails(input) {
    const scholarNo = input.value.trim();
    const memberDiv = input.closest('.member-field');
    const validationMsg = memberDiv.querySelector('.validation-message');
    
    if (!scholarNo) {
        clearMemberFields(memberDiv);
        validationMsg.innerHTML = '';
        return;
    }
    
    // Check if it's the leader's scholar number
    if (scholarNo === '{{ current_user.scholar_no }}') {
        validationMsg.innerHTML = '<span class="text-red-500">You are already the leader!</span>';
        clearMemberFields(memberDiv);
        input.value = '';
        return;
    }
    
    try {
        validationMsg.innerHTML = '<span class="text-blue-500">Checking...</span>';
        
        const response = await fetch(`/student/api/student/${scholarNo}`);
        const data = await response.json();
        
        if (data.exists) {
            if (data.in_toli) {
                validationMsg.innerHTML = '<span class="text-red-500">Student is already in another toli!</span>';
                clearMemberFields(memberDiv);
                input.value = '';
            } else {
                // Auto-fill the fields
                memberDiv.querySelector('.name-field').value = data.name;
                memberDiv.querySelector('.course-field').value = data.course;
                memberDiv.querySelector('.contact-field').value = data.contact;
                memberDiv.querySelector('.email-field').value = data.email;
                validationMsg.innerHTML = '<span class="text-green-500">âœ“ Student found</span>';
            }
        } else {
            validationMsg.innerHTML = '<span class="text-red-500">Student not found!</span>';
            clearMemberFields(memberDiv);
        }
    } catch (error) {
        validationMsg.innerHTML = '<span class="text-red-500">Error fetching student details</span>';
        console.error('Error:', error);
    }
}

function clearMemberFields(memberDiv) {
    memberDiv.querySelector('.name-field').value = '';
    memberDiv.querySelector('.course-field').value = '';
    memberDiv.querySelector('.contact-field').value = '';
    memberDiv.querySelector('.email-field').value = '';
}

// Form validation
document.getElementById('toliForm').addEventListener('submit', function(e) {
    const scholarInputs = document.querySelectorAll('.scholar-input');
    let hasDuplicates = false;
    const scholarNumbers = new Set();
    
    scholarInputs.forEach(input => {
        const scholarNo = input.value.trim();
        if (scholarNo) {
            if (scholarNumbers.has(scholarNo)) {
                hasDuplicates = true;
                input.style.borderColor = 'red';
            } else {
                scholarNumbers.add(scholarNo);
            }
        }
    });
    
    if (hasDuplicates) {
        e.preventDefault();
        alert('Duplicate scholar numbers found! Please remove duplicates.');
    }
});

// Add first member field by default
document.addEventListener('DOMContentLoaded', function() {
    addMemberField();
});
</script>

<style>
.scholar-input:invalid {
    border-color: #ef4444;
}

.member-field {
    transition: all 0.3s ease;
}
</style>
{% endblock %}